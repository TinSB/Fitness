import React, { useState, useMemo, useRef, useEffect } from 'react';
import { 
  Dumbbell, Activity, ChevronRight, Info, Flame, Calculator, X, 
  CheckCircle, AlertTriangle, ChevronDown, Sparkles, Loader2, Send, 
  Filter, MonitorSmartphone, BookOpen, ArrowLeft
} from 'lucide-react';

// --- 0. Gemini API Configuration ---
const apiKey = ""; // ç³»ç»Ÿä¼šè‡ªåŠ¨æ³¨å…¥ API Key

const callGemini = async (prompt) => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
        }),
      }
    );

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "æŠ±æ­‰ï¼ŒAI æ•™ç»ƒç°åœ¨æœ‰ç‚¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚";
  }
};

// --- 1. å‡çº§åçš„æ•°æ®åº“ (Official Names & Images) ---
// æ•°æ®æ¥æºï¼šåŸºäºæ‚¨ä¸Šä¼ çš„ã€Š40ç§å¥èº«æˆ¿å¸¸ç”¨å™¨æ¢°å™¨æçš„åç§°å’Œç”¨æ³•ã€‹åŠã€Šè€æ²ˆè°ˆå¥èº«ã€‹æ•´ç†
const EXERCISE_DATA = [
  // === è…¿éƒ¨ Legs ===
  {
    id: 'l1',
    name: 'åå§¿æ¨è…¿æœº (Seated Leg Press)',
    category: 'è…¿éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['è‚¡å››å¤´è‚Œ', 'è‡€å¤§è‚Œ', 'è…˜ç»³è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Leg+Press+Machine',
    description: 'é€šè¿‡æ¨è¹¬è¸æ¿è®­ç»ƒä¸‹è‚¢åŠ›é‡ï¼Œå›ºå®šè½¨è¿¹å¯¹è…°èƒŒå‹å¥½ï¼Œæ˜¯å¤§éƒ¨åˆ†æ–°æ‰‹è¸å…¥è…¿éƒ¨è®­ç»ƒçš„å®‰å…¨èµ·ç‚¹ã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…ï¼Œä½¿è†ç›–åœ¨èµ·å§‹ä½ç½®çº¦å¼¯æ›² 90åº¦ï¼ŒèƒŒéƒ¨å®Œå…¨è´´ç´§é å«ã€‚',
      'åŒè„šä¸è‚©åŒå®½æ”¾åœ¨è¸æ¿ä¸Šï¼Œè„šå°–ç•¥å¾®å¤–å±•ï¼Œè„šè·Ÿè¸©å®ã€‚',
      'å¸æ°”ç¼“æ…¢å¼¯æ›²è†ç›–è®©è¸æ¿ä¸‹é™ï¼Œé¿å…é‡é‡å®Œå…¨è½åˆ°åº•é€ æˆå†²å‡»ã€‚',
      'å‘¼æ°”ç”¨è„šè·Ÿå‘åŠ›æ¨èµ·è¸æ¿ï¼Œé¡¶ç«¯è†ç›–ä¿ç•™è½»å¾®å¼¯æ›²ï¼Œä¸è¦é”æ­»ã€‚'
    ],
    tips: [
      'å…¨ç¨‹ä¿æŒä¸‹èƒŒè´´é å«ï¼Œé¿å…è…°éƒ¨æ‹±èµ·å¯¼è‡´è…°æ¤å—å‹ã€‚',
      'è†ç›–ä¸è„šå°–æ–¹å‘ä¿æŒä¸€è‡´ï¼Œé¿å…æ˜æ˜¾å†…æ‰£æˆ–å¤–ç¿»ã€‚',
      'èŠ‚å¥å»ºè®®ï¼šä¸‹æ”¾çº¦ 2 ç§’ï¼Œæ¨èµ·çº¦ 1 ç§’ï¼Œç¦æ­¢å¼¹éœ‡å’ŒçŒ›è¹¬ã€‚'
    ]
  },
  {
    id: 'l2',
    name: 'åå§¿è…¿å±ˆä¼¸æœº (Leg Extension)',
    category: 'è…¿éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['è‚¡å››å¤´è‚Œ (å¤§è…¿å‰ä¾§)'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Leg+Extension',
    description: 'å­¤ç«‹åˆºæ¿€å¤§è…¿å‰ä¾§ï¼Œå¯ä½œä¸ºè…¿ä¸¾æˆ–æ·±è¹²åé’ˆå¯¹æ€§è¡¥å……åŠ¨ä½œï¼Œåˆ»ç”»å¤§è…¿çº¿æ¡ã€‚',
    steps: [
      'è°ƒæ•´é å«é«˜åº¦ï¼Œä½¿è†å…³èŠ‚ä¸æœºå™¨æ—‹è½¬è½´å¯¹é½ï¼Œå°è…¿å«åœ¨è„šè¸ä¸Šæ–¹ã€‚',
      'åŒæ‰‹æ‰¶æ¡æŠŠç¨³å®šèº«ä½“ï¼Œæ”¶ç´§å¤§è…¿å‰ä¾§ã€‚',
      'å‘¼æ°”æ—¶ä¼¸ç›´è†å…³èŠ‚ï¼Œå°†å°è…¿å‘å‰æŠ¬èµ·ï¼Œé¡¶ç«¯ç¨ä½œåœé¡¿ã€‚',
      'å¸æ°”æ—¶ç¼“æ…¢ä¸‹æ”¾å›èµ·å§‹ä½ç½®ï¼Œä¸è¦è®©é…é‡å®Œå…¨è½åº•ã€‚'
    ],
    tips: [
      'é‡é‡ä¸å®œè¿‡å¤§ï¼Œè†å…³èŠ‚æœ‰ä¸é€‚å²çš„äººé¿å…å¤§é‡é‡å†²å‡»ã€‚',
      'å‘åŠ›æ—¶ä¸“æ³¨æƒ³è±¡å¤§è…¿å‰ä¾§å‘åŠ›ï¼Œä¸è¦çŒ›ç”©å°è…¿ã€‚'
    ]
  },
  {
    id: 'l3',
    name: 'ä¿¯å§è…¿å¼¯ä¸¾æœº (Lying Leg Curl)',
    category: 'è…¿éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['è…˜ç»³è‚Œ (å¤§è…¿åä¾§)', 'è‡€å¤§è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Lying+Leg+Curl',
    description: 'ä¸»è¦è®­ç»ƒå¤§è…¿åä¾§ï¼Œæœ‰åŠ©äºå¹³è¡¡å‰åä¾§è‚Œè‚‰åŠ›é‡ï¼Œä¿æŠ¤è†å…³èŠ‚ã€‚',
    steps: [
      'ä¿¯å§åœ¨å™¨æ¢°ä¸Šï¼Œè†å…³èŠ‚ä¸æ—‹è½¬è½´å¯¹é½ï¼Œå°è…¿å«åœ¨è„šè¸ä¸Šæ–¹ã€‚',
      'æ”¶ç´§æ ¸å¿ƒä¸è‡€éƒ¨ï¼Œä¿æŒé«‹éƒ¨è´´è¿‘å«å­ã€‚',
      'å‘¼æ°”æ—¶å¼¯æ›²è†å…³èŠ‚ï¼Œå°†è„šè·Ÿå‘è‡€éƒ¨æ–¹å‘æ‹‰èµ·ã€‚',
      'å¸æ°”æ—¶ç¼“æ…¢è¿˜åŸï¼Œé…é‡ä¸å®Œå…¨è½åº•ã€‚'
    ],
    tips: [
      'é¿å…è‡€éƒ¨æ˜æ˜¾æŠ¬ç¦»å«å­ï¼Œå¦åˆ™ä¼šåˆ†æ•£åˆºæ¿€å¹¶å¢åŠ ä¸‹èƒŒå‹åŠ›ã€‚',
      'é‡é‡å®å¯è½»ä¸€äº›ä¹Ÿä¸è¦çŒ›ç”©è„šï¼Œä¿æŒå…¨ç¨‹æ§åˆ¶ã€‚'
    ]
  },
  {
    id: 'l4',
    name: 'å“ˆå…‹æ·±è¹²æœº (Hack Squat)',
    category: 'è…¿éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['è‚¡å››å¤´è‚Œ', 'è‡€å¤§è‚Œ'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Hack+Squat',
    description: 'å›ºå®šè½¨è¿¹çš„æ·±è¹²ï¼Œå¯¹è†ç›–å’Œè…°èƒŒæ›´å‹å¥½ï¼Œé€‚åˆæƒ³ç»ƒæ·±è¹²ä½†æ ¸å¿ƒä¸ç¨³çš„äººã€‚',
    steps: [
      'åŒè‚©é¡¶ä½è½¯å«ï¼ŒèƒŒéƒ¨è´´ç´§é èƒŒã€‚',
      'åŒè„šè¸åœ¨è¸æ¿ä¸Šï¼Œè§£é”å¼€å…³ã€‚',
      'æ·±è¹²è‡³å¤§è…¿å¹³è¡Œè¸æ¿ï¼Œç”¨åŠ›è¹¬èµ·ã€‚'
    ],
    tips: [
      'è„šç«™å¾—è¶Šé ä¸‹è¶Šä¾§é‡è‚¡å››å¤´è‚Œï¼Œè¶Šé ä¸Šè¶Šä¾§é‡è‡€éƒ¨ã€‚',
      'å…¨ç¨‹ä¿æŒè…°èƒŒè´´ç´§é èƒŒã€‚'
    ]
  },
  {
    id: 'l5',
    name: 'æ é“ƒæ·±è¹² (Barbell Squat)',
    category: 'è…¿éƒ¨',
    equipment: 'æ é“ƒ',
    muscles: ['è‚¡å››å¤´è‚Œ', 'è‡€å¤§è‚Œ', 'æ ¸å¿ƒ'],
    difficulty: 'å›°éš¾',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Barbell+Squat',
    description: 'åŠ›é‡è®­ç»ƒä¹‹ç‹ï¼Œç»¼åˆæå‡ä¸‹è‚¢åŠ›é‡ä¸æ ¸å¿ƒç¨³å®šæ€§ã€‚',
    steps: [
      'æ é“ƒç½®äºæ–œæ–¹è‚Œä¸Šï¼ŒåŒè„šç•¥å®½äºè‚©ã€‚',
      'å¸æ°”æ”¶ç´§æ ¸å¿ƒï¼Œè‡€éƒ¨å‘ååå¹¶å¼¯æ›²è†ç›–ã€‚',
      'ä¸‹è¹²è‡³å¤§è…¿ä¸åœ°é¢å¹³è¡Œæˆ–ç•¥ä½ã€‚',
      'è„šè·Ÿå‘åŠ›ç«™èµ·ï¼Œä¿æŒèƒ¸éƒ¨å‘å‰å‘ä¸Šã€‚'
    ],
    tips: [
      'å»ºè®®å…ˆä»å¾’æ‰‹æˆ–å²å¯†æ–¯æœºç»ƒä¹ ï¼Œç¡®è®¤åŠ¨ä½œç¨³å®šå†ä¸Šæ é“ƒã€‚',
      'å…¨ç¨‹ä¿æŒè…°èƒŒæŒºç›´ï¼Œé¿å…åœ†èƒŒã€‚'
    ]
  },

  // === èƒ¸éƒ¨ Chest ===
  {
    id: 'c1',
    name: 'åå§¿æ¨èƒ¸æœº (Chest Press Machine)',
    category: 'èƒ¸éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['èƒ¸å¤§è‚Œ', 'ä¸‰è§’è‚Œå‰æŸ', 'è‚±ä¸‰å¤´è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Chest+Press',
    description: 'æ¨¡æ‹Ÿå§æ¨çš„æ¨ä¸¾åŠ¨ä½œï¼Œè½¨è¿¹å›ºå®šï¼Œæ›´ä¾¿äºæ–°æ‰‹é”å®šèƒ¸éƒ¨å‘åŠ›ï¼Œå®‰å…¨æ€§é«˜ã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…é«˜åº¦ï¼Œä½¿æŠŠæ‰‹å¤§è‡´åœ¨èƒ¸ä¸­éƒ¨ç•¥ä½ä½ç½®ã€‚',
      'èƒŒéƒ¨ç´§è´´é å«ï¼ŒåŒè„šç¨³è¸©åœ°é¢ï¼Œæ¡ä½æŠŠæ‰‹ã€‚',
      'å¸æ°”æ—¶ç¼“æ…¢è®©æŠŠæ‰‹å›åˆ°æ¥è¿‘èƒ¸éƒ¨ä½ç½®ã€‚',
      'å‘¼æ°”æ—¶ç”¨èƒ¸éƒ¨å‘åŠ›å°†æŠŠæ‰‹æ¨å‘å‰æ–¹ã€‚'
    ],
    tips: [
      'æƒ³è±¡ç”¨èƒ¸æŠŠæŠŠæ‰‹æ¨å‡ºå»ï¼Œè€Œä¸æ˜¯ä»…é æ‰‹è‡‚ç”¨åŠ›ã€‚',
      'ä¿æŒè‚©èƒ›ç•¥å‘åæ”¶ç´§ï¼Œæœ‰åŠ©äºæé«˜èƒ¸è‚Œå‚ä¸åº¦ã€‚'
    ]
  },
  {
    id: 'c2',
    name: 'è´è¶æœºå¤¹èƒ¸ (Pec Deck Fly)',
    category: 'èƒ¸éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['èƒ¸å¤§è‚Œ (ä¸­ç¼/å†…ä¾§)'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Pec+Deck+Fly',
    description: 'é€šè¿‡åŒè‡‚åˆæ‹¢åŠ¨ä½œé›†ä¸­åˆºæ¿€èƒ¸å†…ä¾§ï¼Œé€‚åˆä½œä¸ºæ¨ä¸¾åè¡¥å……åŠ¨ä½œã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…é«˜åº¦ï¼Œä½¿ä¸Šè‡‚ä¸åœ°é¢å¤§è‡´å¹³è¡Œã€‚',
      'åŒå‰è‡‚æˆ–æ‰‹è‚˜è´´åœ¨å«å­ä¸Šï¼Œèƒ¸éƒ¨æŒºèµ·ã€‚',
      'å‘¼æ°”æ—¶å‘å‰åˆæ‹¢åŒè‡‚ï¼Œè‡³æ‰‹è‚˜æ¥è¿‘ç›¸ç¢°ã€‚',
      'å¸æ°”æ—¶ç¼“æ…¢å›åˆ°èµ·å§‹ä½ç½®ï¼Œä¿æŒèƒ¸éƒ¨æ‰“å¼€ã€‚'
    ],
    tips: [
      'è‚˜å…³èŠ‚è§’åº¦å¤§è‡´ä¿æŒä¸å˜ï¼Œé¿å…å˜æˆæ¨ä¸¾åŠ¨ä½œã€‚',
      'é¡¶å³°æ”¶ç¼©åœé¡¿ 1 ç§’ï¼Œæ„Ÿå—èƒ¸è‚ŒæŒ¤å‹ã€‚'
    ]
  },
  {
    id: 'c3',
    name: 'å¹³æ¿æ é“ƒå§æ¨ (Barbell Bench Press)',
    category: 'èƒ¸éƒ¨',
    equipment: 'æ é“ƒ',
    muscles: ['èƒ¸å¤§è‚Œ', 'è‚±ä¸‰å¤´è‚Œ', 'å‰ä¸‰è§’è‚Œ'],
    difficulty: 'å›°éš¾',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Bench+Press',
    description: 'ç»å…¸çš„èƒ¸éƒ¨åŠ›é‡åŠ¨ä½œä¹‹ä¸€ï¼Œé€‚åˆæœ‰ä¸€å®šåŸºç¡€åé€æ¸å¢åŠ é‡é‡ã€‚',
    steps: [
      'ä»°å§åœ¨å§æ¨å‡³ä¸Šï¼Œçœ¼ç›å¤§è‡´å¯¹å‡†æ é“ƒã€‚',
      'ç•¥æ”¶è‚©èƒ›å’Œä¸‹èƒŒå½¢æˆç¨³å®šæ”¯æ’‘ï¼ŒåŒè„šç¨³è¸©åœ°é¢ã€‚',
      'å°†æ é“ƒä»æ¶ä¸Šç§»å‡ºï¼Œå¸æ°”æ—¶ç¼“æ…¢ä¸‹æ”¾è‡³èƒ¸ä¸­éƒ¨é™„è¿‘ã€‚',
      'å‘¼æ°”æ—¶ç”¨èƒ¸å’Œæ‰‹è‡‚å‘åŠ›å°†æ é“ƒæ¨å›èµ·å§‹ä½ç½®ã€‚'
    ],
    tips: [
      'å…¨ç¨‹é¿å…è€¸è‚©ï¼Œä¿æŒè‚©èƒ›ç¨³å®šä»¥ä¿æŠ¤è‚©å…³èŠ‚ã€‚',
      'ä¸‹æ”¾æ—¶ä¸è¦ç ¸èƒ¸ï¼Œä¿æŒå¯æ§çš„æ¥è¿‘è§¦ç¢°ã€‚'
    ]
  },
  {
    id: 'c4',
    name: 'ä¸Šæ–œå“‘é“ƒå§æ¨ (Incline Dumbbell Press)',
    category: 'èƒ¸éƒ¨',
    equipment: 'å“‘é“ƒ',
    muscles: ['èƒ¸å¤§è‚Œä¸ŠæŸ', 'å‰ä¸‰è§’è‚Œ'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Incline+DB+Press',
    description: 'é’ˆå¯¹ä¸Šèƒ¸éƒ¨çš„é»„é‡‘åŠ¨ä½œï¼Œè®©èƒ¸å‹æ›´é¥±æ»¡æŒºæ‹”ã€‚',
    steps: [
      'å°†å“‘é“ƒå‡³è°ƒèŠ‚è‡³30-45åº¦ä¸Šæ–œã€‚',
      'åŒæ‰‹æŒå“‘é“ƒä¸¾è‡³è‚©éƒ¨ä¸Šæ–¹ï¼ŒæŒå¿ƒæœå‰ã€‚',
      'å‚ç›´å‘ä¸Šæ¨èµ·ï¼Œæ„Ÿå—ä¸Šèƒ¸æ”¶ç¼©ã€‚',
      'ä¸‹æ”¾æ—¶å……åˆ†æ‹‰ä¼¸ä¸Šèƒ¸ã€‚'
    ],
    tips: [
      'è§’åº¦ä¸è¦è¶…è¿‡60åº¦ï¼Œå¦åˆ™ä¼šè¿‡å¤šç»ƒåˆ°è‚©è†€ã€‚',
      'ä¸‹æ”¾æ—¶æ„Ÿå—èƒ¸å¤§è‚Œè¢«æ‹‰ä¼¸ï¼Œä¸è¦åˆ©ç”¨æƒ¯æ€§ã€‚'
    ]
  },

  // === èƒŒéƒ¨ Back ===
  {
    id: 'b1',
    name: 'é«˜ä½ä¸‹æ‹‰æœº (Lat Pulldown)',
    category: 'èƒŒéƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['èƒŒé˜”è‚Œ', 'å¤§åœ†è‚Œ', 'è‚±äºŒå¤´è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Lat+Pulldown',
    description: 'æ¨¡æ‹Ÿå¼•ä½“å‘ä¸Šçš„æ‹‰åŠ¨åŠ¨ä½œï¼Œæ˜¯æ–°æ‰‹è®­ç»ƒèƒŒé˜”è‚Œçš„æ ¸å¿ƒåŠ¨ä½œä¹‹ä¸€ã€‚',
    steps: [
      'ååœ¨å™¨æ¢°ä¸Šï¼Œè°ƒæ•´å¤§è…¿å‹å«å›ºå®šèº«ä½“ã€‚',
      'å®½æ¡æ¨ªæ ï¼Œå¾®å¾®åä»°çº¦ 10â€“15åº¦ï¼Œèƒ¸éƒ¨æŠ¬èµ·ã€‚',
      'å‘¼æ°”æ—¶å°†æ¨ªæ æ‹‰å‘ä¸Šèƒ¸æˆ–é”éª¨é™„è¿‘ã€‚',
      'å¸æ°”æ—¶æ§åˆ¶æ¨ªæ ç¼“æ…¢å›åˆ°èµ·å§‹ä½ç½®ã€‚'
    ],
    tips: [
      'æƒ³è±¡è…‹ä¸‹å¤¹ä½ä¸œè¥¿ï¼Œç”¨èƒŒè€Œä¸æ˜¯çº¯æ‰‹è‡‚å‘åŠ›ã€‚',
      'é¿å…èº«ä½“å¤§å¹…æ‘‡æ‘†å€ŸåŠ›ï¼Œé‡é‡è¿‡å¤§å°±å‡è½»ã€‚'
    ]
  },
  {
    id: 'b2',
    name: 'åå§¿åˆ’èˆ¹æœº (Seated Row Machine)',
    category: 'èƒŒéƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['ä¸­èƒŒéƒ¨', 'èƒŒé˜”è‚Œ', 'è±å½¢è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Seated+Row',
    description: 'å¢åŠ èƒŒéƒ¨åšåº¦ï¼Œæ”¹å–„åœ†è‚©é©¼èƒŒï¼Œèƒ¸å«è¾…åŠ©æ›´å®‰å…¨ã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…ä¸èƒ¸å«ï¼Œè®©èƒ¸éƒ¨èˆ’é€‚è´´é ã€‚',
      'åŒæ‰‹æ¡ä½æŠŠæ‰‹ï¼Œè‚©è†€æ”¾æ¾ä¸‹æ²‰ã€‚',
      'å‘¼æ°”æ—¶å¤¹ç´§è‚©èƒ›éª¨ï¼Œå°†æŠŠæ‰‹æ‹‰å‘èº«ä½“ã€‚',
      'å¸æ°”æ—¶æ§åˆ¶è¿˜åŸï¼Œæ‰‹è‡‚ä¼¸ç›´ä½†ä¸è€¸è‚©ã€‚'
    ],
    tips: [
      'åŠ¨ä½œé¡ºåºï¼šå…ˆå¤¹è‚©èƒ›ï¼Œå†ç”¨æ‰‹è‡‚å¼¯æ›²æ‹‰åŠ¨ã€‚',
      'ä¿æŒå¤´éƒ¨ä¸­ç«‹ï¼Œé¿å…æ¢å¤´ã€‚'
    ]
  },
  {
    id: 'b3',
    name: 'è¾…åŠ©å¼•ä½“å‘ä¸Šæœº (Assisted Pull-up)',
    category: 'èƒŒéƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['èƒŒé˜”è‚Œ', 'è‚±äºŒå¤´è‚Œ'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Assisted+Pull-up',
    description: 'åšä¸äº†æ ‡å‡†å¼•ä½“å‘ä¸Šæ—¶çš„æœ€ä½³è¿›é˜¶å™¨æ¢°ã€‚',
    steps: [
      'è°ƒèŠ‚é…é‡ï¼ˆæ³¨æ„ï¼šé…é‡è¶Šé‡è¶ŠçœåŠ›ï¼‰ã€‚',
      'åŒè†è·ªåœ¨è¾…åŠ©å«ä¸Šï¼ŒåŒæ‰‹å®½æ¡æ¡æŠŠã€‚',
      'èƒŒéƒ¨å‘åŠ›å°†èº«ä½“æ‹‰èµ·ï¼Œç›´åˆ°ä¸‹å·´è¿‡æ†ã€‚',
      'ç¼“æ…¢ä¸‹æ”¾ã€‚'
    ],
    tips: [
      'ä¸è¦ä¾é æƒ¯æ€§ä¸Šä¸‹å¼¹åŠ¨ã€‚',
      'å…¨ç¨‹ä¿æŒæ ¸å¿ƒæ”¶ç´§ã€‚'
    ]
  },
  {
    id: 'b4',
    name: 'ä¿¯èº«æ é“ƒåˆ’èˆ¹ (Barbell Row)',
    category: 'èƒŒéƒ¨',
    equipment: 'æ é“ƒ',
    muscles: ['èƒŒé˜”è‚Œ', 'è±å½¢è‚Œ', 'ç«–è„Šè‚Œ'],
    difficulty: 'å›°éš¾',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Barbell+Row',
    description: 'å…¸å‹çš„åšèƒŒåŠ¨ä½œï¼Œå¯¹è…°èƒŒç¨³å®šæ€§è¦æ±‚è¾ƒé«˜ï¼Œé€‚åˆå·²æœ‰åŸºç¡€çš„äººã€‚',
    steps: [
      'åŒè„šä¸é«‹åŒå®½ç«™ç«‹ï¼Œé«‹å…³èŠ‚æŠ˜å ï¼Œèº«ä½“å‰å€¾çº¦ 45åº¦ã€‚',
      'åŒæ‰‹ç•¥å®½äºè‚©æ¡æ ï¼ŒèƒŒéƒ¨ä¿æŒä¸­ç«‹ï¼Œæ ¸å¿ƒæ”¶ç´§ã€‚',
      'å‘¼æ°”æ—¶å°†æ é“ƒæ‹‰å‘è‚šè„æˆ–ä¸‹è…¹éƒ¨ã€‚',
      'å¸æ°”æ—¶æ§åˆ¶ä¸‹æ”¾ã€‚'
    ],
    tips: [
      'å…¨ç¨‹ä¿æŒä¸‹èƒŒç´§å¼ ï¼Œä¸è¦å¡Œè…°åœ†èƒŒã€‚',
      'å¦‚è…°éƒ¨æœ‰æ—¢å¾€ä¸é€‚ï¼Œä¼˜å…ˆä½¿ç”¨åå§¿åˆ’èˆ¹ç­‰å™¨æ¢°æ›¿ä»£ã€‚'
    ]
  },

  // === è‚©éƒ¨ Shoulders ===
  {
    id: 's1',
    name: 'åå§¿æ¨è‚©æœº (Shoulder Press Machine)',
    category: 'è‚©éƒ¨',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['ä¸‰è§’è‚Œå‰æŸ', 'ä¸‰è§’è‚Œä¸­æŸ', 'è‚±ä¸‰å¤´è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Shoulder+Press',
    description: 'åœ¨å›ºå®šè½¨è¿¹ä¸‹ç»ƒä¹ å¤´é¡¶æ¨ä¸¾åŠ¨ä½œï¼Œå¯¹æ ¸å¿ƒç¨³å®šæ€§è¦æ±‚è¾ƒä½ï¼Œæ˜¯è‚©æ¨å…¥é—¨é€‰æ‹©ã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…é«˜åº¦ï¼Œä½¿æŠŠæ‰‹å¤§è‡´ä½äºä¸‹å·´åˆ°è€³æœµä¹‹é—´ã€‚',
      'èƒŒéƒ¨è´´ç´§é å«ï¼ŒåŒè„šç¨³è¸©åœ°é¢ã€‚',
      'å‘¼æ°”æ—¶å°†æŠŠæ‰‹å‘ä¸Šæ¨ä¸¾è‡³æ‰‹è‡‚æ¥è¿‘ä¼¸ç›´ã€‚',
      'å¸æ°”æ—¶æ§åˆ¶æŠŠæ‰‹ä¸‹æ”¾å›èµ·å§‹ä½ç½®ã€‚'
    ],
    tips: [
      'é¿å…è€¸è‚©ï¼Œé¢ˆéƒ¨ä¿æŒæ”¾æ¾ã€‚',
      'è‚©å…³èŠ‚ä¸èˆ’æœçš„æƒ…å†µä¸‹ä¸è¦åœ¨ä½ä½è¿‡åº¦ä¸‹æ”¾ã€‚'
    ]
  },
  {
    id: 's2',
    name: 'å“‘é“ƒä¾§å¹³ä¸¾ (Dumbbell Lateral Raise)',
    category: 'è‚©éƒ¨',
    equipment: 'å“‘é“ƒ',
    muscles: ['ä¸‰è§’è‚Œä¸­æŸ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Lateral+Raise',
    description: 'æŠŠè‚©è†€ç»ƒå®½ï¼ˆå¢åŠ è‚©å®½/æ‰“é€ ç›´è§’è‚©ï¼‰çš„å¿…åšåŠ¨ä½œã€‚',
    steps: [
      'ç«™å§¿æˆ–åå§¿ï¼ŒåŒæ‰‹æŒå“‘é“ƒå‚äºä½“ä¾§ã€‚',
      'æ‰‹è‚˜å¾®å±ˆï¼Œå‘èº«ä½“ä¸¤ä¾§ä¸¾èµ·å“‘é“ƒè‡³ä¸è‚©åŒé«˜ã€‚',
      'ç¼“æ…¢æ§åˆ¶ä¸‹æ”¾ã€‚'
    ],
    tips: [
      'å°±åƒå¾€ä¸¤è¾¹å€’æ°´ä¸€æ ·ï¼ˆæ‰‹è‚˜ç•¥é«˜äºæ‰‹è…•ï¼‰ã€‚',
      'ä¸è¦ç”¨èº«ä½“æ™ƒåŠ¨å€ŸåŠ›ï¼Œé‡é‡ä¸å®œè¿‡å¤§ã€‚'
    ]
  },
  {
    id: 's3',
    name: 'é¢æ‹‰ (Face Pull)',
    category: 'è‚©éƒ¨',
    equipment: 'ç»³ç´¢',
    muscles: ['ä¸‰è§’è‚ŒåæŸ', 'è‚©è¢–è‚Œç¾¤'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Face+Pull',
    description: 'æ”¹å–„åœ†è‚©é©¼èƒŒï¼Œå¼ºåŒ–è‚©éƒ¨å¥åº·çš„æä½³åŠ¨ä½œã€‚',
    steps: [
      'é¾™é—¨æ¶è°ƒè‡³é«˜ä½ï¼Œå®‰è£…ç»³ç´¢å¤´ã€‚',
      'åŒæ‰‹å¯¹æ¡ç»³ç´¢ï¼Œå‘é¢éƒ¨æ‹‰åŠ¨ã€‚',
      'åœ¨æœ«ç«¯å¤–æ—‹æ‰‹è‡‚ï¼Œå±•ç¤ºäºŒå¤´è‚Œå§¿åŠ¿ã€‚'
    ],
    tips: [
      'åŠ¨ä½œé‡ç‚¹æ˜¯æ‰‹è‚˜å‘åå¼€ï¼Œè€Œä¸æ˜¯å•çº¯æ‹‰ã€‚',
      'é‡é‡è½»ä¸€ç‚¹ï¼Œæ³¨é‡æ§åˆ¶ã€‚'
    ]
  },

  // === æ‰‹è‡‚ Arms ===
  {
    id: 'a1',
    name: 'äºŒå¤´å¼¯ä¸¾æœº (Bicep Curl Machine)',
    category: 'æ‰‹è‡‚',
    equipment: 'å›ºå®šå™¨æ¢°',
    muscles: ['è‚±äºŒå¤´è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Bicep+Curl+Machine',
    description: 'è½¨è¿¹å›ºå®šï¼Œèƒ½å¸®åŠ©æ–°æ‰‹å­¦ä¼šâ€œé”æ­»è‚˜éƒ¨â€çš„å¼¯ä¸¾æ¨¡å¼ï¼Œå‡å°‘ä¹±æ™ƒã€‚',
    steps: [
      'è°ƒæ•´åº§æ¤…é«˜åº¦ï¼Œä½¿ä¸Šè‡‚èˆ’é€‚è´´åœ¨å«å­ä¸Šã€‚',
      'åŒæ‰‹æ¡æŠŠï¼Œæ‰‹è‡‚è‡ªç„¶ä¼¸ç›´ä½†ä¸é”æ­»ã€‚',
      'å‘¼æ°”æ—¶å¼¯æ›²è‚˜å…³èŠ‚ï¼Œå°†æŠŠæ‰‹å·èµ·è‡³æ¥è¿‘è‚©éƒ¨ã€‚',
      'å¸æ°”æ—¶ç¼“æ…¢ä¸‹æ”¾å›åˆ°èµ·å§‹ä½ç½®ã€‚'
    ],
    tips: [
      'è‚©éƒ¨æ”¾æ¾ï¼Œä¸è¦è€¸è‚©ä»£æ›¿æ‰‹è‡‚å‘åŠ›ã€‚',
      'é¿å…å€ŸåŠ©èº«ä½“æ‘†åŠ¨ï¼Œä¸“æ³¨æ„Ÿå—äºŒå¤´è‚Œæ”¶ç¼©å’Œæ‹‰ä¼¸ã€‚'
    ]
  },
  {
    id: 'a2',
    name: 'ç»³ç´¢ä¸‹å‹ (Triceps Pushdown)',
    category: 'æ‰‹è‡‚',
    equipment: 'ç»³ç´¢',
    muscles: ['è‚±ä¸‰å¤´è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Triceps+Pushdown',
    description: 'å‘å±•æ‰‹è‡‚åä¾§çº¿æ¡çš„å¸¸è§„åŠ¨ä½œï¼Œæ¶ˆé™¤æ‹œæ‹œè‚‰ã€‚',
    steps: [
      'ç»³ç´¢å›ºå®šåœ¨é«˜ä½ï¼ŒåŒæ‰‹æ¡ç»³ä¸¤ç«¯ï¼Œè‚˜éƒ¨è´´è¿‘èº«ä½“ä¸¤ä¾§ã€‚',
      'ä¸Šè‡‚ä¿æŒç¨³å®šï¼Œåªè®©å‰è‡‚æ´»åŠ¨ã€‚',
      'å‘¼æ°”æ—¶å‘ä¸‹ä¼¸å±•æ‰‹è‡‚è‡³è‚˜å…³èŠ‚æ¥è¿‘ä¼¸ç›´ã€‚',
      'å¸æ°”æ—¶æ§åˆ¶è¿˜åŸã€‚'
    ],
    tips: [
      'ä¸è¦è®©è‚˜éƒ¨å‘å‰è·‘ä½ï¼Œä¸Šè‡‚å›ºå®šæ˜¯å…³é”®ã€‚',
      'æœ«ç«¯å¯ä»¥ç•¥å¾®å‘ä¸¤ä¾§åˆ†å¼€ç»³ç´¢ï¼ŒåŠ å¼ºä¸‰å¤´æ”¶ç¼©æ„Ÿã€‚'
    ]
  },

  // === æœ‰æ°§ & åŠŸèƒ½æ€§ Cardio/Functional ===
  {
    id: 'f1',
    name: 'åˆ’èˆ¹æœº (Rowing Machine)',
    category: 'æœ‰æ°§',
    equipment: 'æœ‰æ°§å™¨æ¢°',
    muscles: ['å…¨èº«85%è‚Œè‚‰', 'èƒŒéƒ¨', 'è…¿éƒ¨'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Rowing+Machine',
    description: 'é«˜æ•ˆç‡ƒè„‚ä¸”ä¸ä¼¤è†ç›–çš„å…¨èº«æ€§è¿åŠ¨ï¼Œæ¨¡æ‹Ÿæ°´ä¸Šåˆ’èˆ¹ã€‚',
    steps: [
      'è¹¬è…¿ï¼šå…ˆç”¨åŒè…¿çˆ†å‘åŠ›è¹¬å‡ºã€‚',
      'åå€’ï¼šè…¿ä¼¸ç›´åï¼Œèº«ä½“å¾®åä»°ã€‚',
      'æ‹‰æ‰‹ï¼šæœ€åå°†æ‰‹æŸ„æ‹‰è‡³èƒ¸å£ã€‚',
      'å›ç¨‹ï¼šå…ˆä¼¸æ‰‹ï¼Œå†å›èº«ï¼Œæœ€åå±ˆè†ã€‚'
    ],
    tips: [
      'é¡ºåºå£è¯€ï¼šè…¿-èº«-æ‰‹ï¼Œæ‰‹-èº«-è…¿ã€‚',
      'ä¸è¦é©¼èƒŒï¼Œæ ¸å¿ƒå§‹ç»ˆæ”¶ç´§ã€‚'
    ]
  },
  {
    id: 'f2',
    name: 'æˆ˜ç»³ (Battle Rope)',
    category: 'æœ‰æ°§',
    equipment: 'æˆ˜ç»³',
    muscles: ['æ ¸å¿ƒ', 'è‚©éƒ¨', 'å¿ƒè‚º'],
    difficulty: 'å›°éš¾',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Battle+Rope',
    description: 'çŸ­æ—¶é—´æé€Ÿç‡ƒè„‚ï¼Œæå‡çˆ†å‘åŠ›å’Œä»£è°¢æ°´å¹³ã€‚',
    steps: [
      'æ‰é©¬æ­¥ç«™ç«‹ï¼Œæ ¸å¿ƒæ”¶ç´§ï¼ŒèƒŒéƒ¨æŒºç›´ã€‚',
      'åŒæ‰‹æ¡ç»³ï¼Œåˆ©ç”¨è‚©è†€å’Œæ‰‹è‡‚åŠ›é‡ä¸Šä¸‹ç”©åŠ¨ã€‚',
      'åˆ¶é€ æ³¢æµªï¼Œä¿æŒç»³å­æŒç»­æ³¢åŠ¨ã€‚'
    ],
    tips: [
      'ä¸è¦æ†‹æ°”ï¼Œä¿æŒå‘¼å¸èŠ‚å¥ã€‚',
      'ä¸»è¦é æ ¸å¿ƒç¨³å®šèº«ä½“ï¼Œä¸è¦å·¦å³ä¹±æ™ƒã€‚'
    ]
  },
  {
    id: 'f3',
    name: 'è¯çƒç ¸å¢™ (Wall Ball)',
    category: 'æœ‰æ°§',
    equipment: 'è¯çƒ',
    muscles: ['è…¿éƒ¨', 'è‚©éƒ¨', 'çˆ†å‘åŠ›'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Medicine+Ball',
    description: 'ç»“åˆæ·±è¹²å’Œæ¨ä¸¾çš„å…¨èº«çˆ†å‘åŠ›è®­ç»ƒã€‚',
    steps: [
      'é¢å¯¹å¢™å£ï¼ŒåŒæ‰‹æŒçƒç½®äºèƒ¸å‰ã€‚',
      'æ·±è¹²ï¼Œç«™èµ·çš„åŒæ—¶å°†çƒç”¨åŠ›å‘ä¸ŠæŠ›å‘å¢™å£ç›®æ ‡ç‚¹ã€‚',
      'æ¥çƒåé¡ºåŠ¿ä¸‹è¹²ç¼“å†²ï¼Œé‡å¤åŠ¨ä½œã€‚'
    ],
    tips: [
      'åŠ¨ä½œè¦è¿è´¯ï¼Œåˆ©ç”¨è…¿éƒ¨åŠ›é‡ä¼ é€’åˆ°æ‰‹è‡‚ã€‚',
      'æ³¨æ„æ¥çƒæ—¶ä¸è¦ç ¸åˆ°è„¸ã€‚'
    ]
  },
  {
    id: 'f4',
    name: 'TRX æ‚¬æŒ‚æ·±è¹² (TRX Squat)',
    category: 'è…¿éƒ¨',
    equipment: 'TRX',
    muscles: ['è‚¡å››å¤´è‚Œ', 'è‡€å¤§è‚Œ'],
    difficulty: 'ç®€å•',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=TRX+Squat',
    description: 'åˆ©ç”¨æ‚¬æŒ‚ç»³è¾…åŠ©çš„æ·±è¹²ï¼Œé€‚åˆè†ç›–ä¸å¥½æˆ–æ–°æ‰‹æŒæ¡å§¿åŠ¿ã€‚',
    steps: [
      'åŒæ‰‹æ¡ä½TRXæ‰‹æŸ„ï¼Œç»³ç´¢æ‹‰ç›´ã€‚',
      'åƒåæ¤…å­ä¸€æ ·å‘åä¸‹æ–¹è¹²ã€‚',
      'åˆ©ç”¨è…¿éƒ¨åŠ›é‡ç«™èµ·ï¼Œæ‰‹éƒ¨ä»…åšè¾…åŠ©å¹³è¡¡ã€‚'
    ],
    tips: [
      'ä¸è¦è¿‡åº¦ä¾èµ–æ‰‹è‡‚æ‹‰èµ·èº«ä½“ã€‚',
      'èƒŒéƒ¨å§‹ç»ˆæŒºç›´ã€‚'
    ]
  },
  {
    id: 'f5',
    name: 'å£¶é“ƒæ‘†è¡ (Kettlebell Swing)',
    category: 'æœ‰æ°§',
    equipment: 'å£¶é“ƒ',
    muscles: ['è‡€å¤§è‚Œ', 'è…˜ç»³è‚Œ', 'ä¸‹èƒŒéƒ¨'],
    difficulty: 'ä¸­ç­‰',
    image: 'https://placehold.co/600x400/e2e8f0/1e293b?text=Kettlebell+Swing',
    description: 'é«‹å…³èŠ‚é“°é“¾çš„ç»å…¸åŠ¨ä½œï¼Œç»ƒå‡ºå¼ºåŠ›è‡€éƒ¨ã€‚',
    steps: [
      'åŒè„šå®½äºè‚©ï¼ŒåŒæ‰‹æŒå£¶é“ƒäºèƒ¯ä¸‹ã€‚',
      'å±ˆé«‹ï¼ˆå±è‚¡åæ’…ï¼‰ï¼Œç„¶ååˆ©ç”¨è‡€éƒ¨çˆ†å‘åŠ›å‘å‰é¡¶é«‹ã€‚',
      'åˆ©ç”¨æƒ¯æ€§å°†å£¶é“ƒæ‘†è‡³èƒ¸å£é«˜åº¦ã€‚'
    ],
    tips: [
      'è¿™ä¸æ˜¯æ·±è¹²ï¼æ˜¯å±ˆé«‹åŠ¨ä½œã€‚',
      'ä¸»è¦é å±è‚¡å‘åŠ›ï¼Œæ‰‹è‡‚åªæ˜¯é’©å­ï¼Œä¸è¦ç”¨è‚©è†€ç¡¬æ‹‰ã€‚'
    ]
  }
];

const CATEGORIES = ['å…¨éƒ¨', 'èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è…¿éƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'æœ‰æ°§'];
const EQUIPMENT_TYPES = ['å…¨éƒ¨', 'å›ºå®šå™¨æ¢°', 'æ é“ƒ', 'å“‘é“ƒ', 'ç»³ç´¢', 'è‡ªç”±å™¨æ¢°', 'æœ‰æ°§å™¨æ¢°', 'TRX/æˆ˜ç»³', 'å£¶é“ƒ/è¯çƒ'];

// --- 2. ç»„ä»¶ Components ---

// Helper Component: ç®€å•çš„ Markdown æ¸²æŸ“å™¨
// ç”¨äºå°† AI ç”Ÿæˆçš„ç²—ä½“å’Œåˆ—è¡¨è½¬æ¢ä¸ºæ¼‚äº®çš„ UI
const FormattedAIResponse = ({ text }) => {
  if (!text) return null;

  const lines = text.split('\n');
  
  return (
    <div className="space-y-3 text-sm leading-relaxed text-slate-700">
      {lines.map((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return <div key={index} className="h-1"></div>;

        // å¤„ç†æ ‡é¢˜ (## )
        if (trimmed.startsWith('##')) {
          return (
            <h4 key={index} className="text-base font-bold text-slate-900 mt-4 mb-2 flex items-center">
              <div className="w-1 h-5 bg-blue-500 rounded-full mr-2"></div>
              {trimmed.replace(/^##\s*/, '')}
            </h4>
          );
        }

        // å¤„ç†åˆ—è¡¨ (- æˆ– * )
        if (trimmed.match(/^[-*]\s/)) {
          const content = trimmed.replace(/^[-*]\s/, '');
          return (
            <div key={index} className="flex items-start pl-2">
              <span className="mr-2 mt-1.5 w-1.5 h-1.5 bg-blue-400 rounded-full flex-shrink-0"></span>
              <span>{parseBold(content)}</span>
            </div>
          );
        }

        // æ™®é€šæ®µè½
        return <p key={index}>{parseBold(trimmed)}</p>;
      })}
    </div>
  );
};

// è§£æ **bold** è¯­æ³•çš„è¾…åŠ©å‡½æ•°
const parseBold = (text) => {
  const parts = text.split(/\*\*(.*?)\*\*/g);
  return parts.map((part, i) => 
    i % 2 === 1 ? <strong key={i} className="text-slate-900 font-bold">{part}</strong> : part
  );
};

// 2.1 èº«ä½“åˆ†æç»„ä»¶ (Updated Logic & Style)
const BodyAnalyzer = () => {
  const [height, setHeight] = useState('');
  const [weight, setWeight] = useState('');
  const [result, setResult] = useState(null);
  const [aiPlan, setAiPlan] = useState('');
  const [isGeneratingPlan, setIsGeneratingPlan] = useState(false);
  const planRef = useRef(null);

  const calculate = () => {
    if (!height || !weight) return;
    const h = parseFloat(height) / 100; 
    const w = parseFloat(weight); 
    const bmi = (w / (h * h)).toFixed(1);
    
    let type = '';
    let advice = '';
    let proteinRange = '';
    let strategy = '';
    let planDetails = [];

    // Logic based on GymGuide Pro
    if (bmi < 18.5) {
      type = 'åç˜¦';
      strategy = 'å¢è‚Œä¼˜å…ˆ (Bulk)';
      proteinRange = `${(w * 1.6).toFixed(0)} - ${(w * 2.2).toFixed(0)} g`;
      advice = 'ä¼˜å…ˆå¢è‚Œï¼Œå…¼é¡¾å…¨èº«åŠ›é‡å’Œå°‘é‡æœ‰æ°§ï¼Œé˜²æ­¢ä½“é‡ç»§ç»­ä¸‹é™ã€‚é¥®é£Ÿä¸Šä¿è¯è¶³å¤Ÿç¢³æ°´å’Œè›‹ç™½ï¼Œç¡çœ å°½é‡å……è¶³ã€‚';
      planDetails = [
        'Day 1: èƒ¸ + ä¸‰å¤´ + 15 åˆ†é’Ÿè·‘æ­¥æœºå¿«èµ°',
        'Day 2: èƒŒ + äºŒå¤´ + æ ¸å¿ƒï¼ˆå¹³æ¿æ”¯æ’‘ã€æ­»è™«ç­‰ï¼‰',
        'Day 3: è…¿ + è‚© + 10â€“15 åˆ†é’Ÿä½å¼ºåº¦æœ‰æ°§'
      ];
    } else if (bmi < 25) {
      type = 'æ­£å¸¸èŒƒå›´';
      strategy = 'ç»¼åˆæå‡ (Recomp)';
      proteinRange = `${(w * 1.6).toFixed(0)} - ${(w * 2.2).toFixed(0)} g`;
      advice = 'åŠ›é‡å’Œæœ‰æ°§ç»“åˆï¼Œç›®æ ‡æ˜¯è®©å›´åº¦å’Œçº¿æ¡æ›´å¥½çœ‹ã€‚å¦‚æœæƒ³åå‘å‡è„‚ï¼Œç•¥å¾®æ§åˆ¶æ€»çƒ­é‡ï¼›å¦‚æœåå‘å¢è‚Œï¼Œé€‚å½“å¢åŠ æ‘„å…¥ã€‚';
      planDetails = [
        'Day 1: èƒ¸ + ä¸‰å¤´ + 20 åˆ†é’Ÿä¸­ç­‰å¼ºåº¦æœ‰æ°§',
        'Day 2: èƒŒ + äºŒå¤´ + æ ¸å¿ƒ',
        'Day 3: è…¿ + è‚© + 20 åˆ†é’Ÿæœ‰æ°§',
        'Day 4 (å¯é€‰): å…¨èº«å¤åˆåŠ¨ä½œ + è½»åº¦æœ‰æ°§'
      ];
    } else if (bmi < 30) {
      type = 'åé‡';
      strategy = 'å‡è„‚ä¼˜å…ˆ (Cut)';
      proteinRange = `${(w * 1.6).toFixed(0)} - ${(w * 2.0).toFixed(0)} g`;
      advice = 'ä»¥å‡è„‚ä¸ºä¸»ï¼ŒåŒæ—¶ä¿ç•™åŠ›é‡è®­ç»ƒï¼Œé¿å…â€œåªç˜¦ä½“é‡ä¸ç˜¦ä½“å‹â€ã€‚é¥®é£Ÿä¿æŒè½»å¾®çƒ­é‡ç¼ºå£ï¼Œæ§åˆ¶æ²¹ç‚¸å’Œé«˜ç³–ã€‚';
      planDetails = [
        'Day 1: ä¸Šè‚¢åŠ›é‡ï¼ˆèƒ¸/èƒŒ/æ‰‹è‡‚å¤åˆï¼‰+ 25â€“35 åˆ†é’Ÿæœ‰æ°§',
        'Day 2: ä¸‹è‚¢åŠ›é‡ï¼ˆè…¿ä¸¾ã€å¼“æ­¥ç­‰ï¼‰+ 20â€“30 åˆ†é’Ÿæœ‰æ°§',
        'Day 3: çº¯æœ‰æ°§ + æ ¸å¿ƒ (30â€“45 åˆ†é’Ÿ)',
        'Day 4: å…¨èº«å¾ªç¯å™¨æ¢°è®­ç»ƒ + 20 åˆ†é’Ÿæœ‰æ°§'
      ];
    } else {
      type = 'è‚¥èƒ–';
      strategy = 'å®‰å…¨å‡è„‚';
      proteinRange = `${(w * 1.2).toFixed(0)} - ${(w * 1.5).toFixed(0)} g`;
      advice = 'ä½å†²å‡»æœ‰æ°§ + å™¨æ¢°åŠ›é‡ä¸ºä¸»ï¼Œå¾ªåºæ¸è¿›å‡è„‚ï¼Œå®‰å…¨æ€§ä¼˜å…ˆã€‚å¦‚æœ‰å…³èŠ‚é—®é¢˜ï¼Œè¯·é¿å…é«˜å†²å‡»è·³è·ƒã€‚';
      planDetails = [
        'Day 1: å…¨èº«å™¨æ¢°åŠ›é‡ + 15â€“20 åˆ†é’Ÿä½å†²å‡»æœ‰æ°§',
        'Day 2: å¿«èµ° / æ¤­åœ†æœº / å•è½¦ 30â€“45 åˆ†é’Ÿ',
        'Day 3: ä¼‘æ¯æˆ–è½»æ´»åŠ¨',
        'Day 4: å…¨èº«å™¨æ¢°åŠ›é‡ + 20â€“30 åˆ†é’Ÿæœ‰æ°§',
        'Day 5: ä¸­ç­‰å¼ºåº¦æœ‰æ°§ 30 åˆ†é’Ÿ'
      ];
    }

    setResult({ bmi, type, protein: proteinRange, advice, strategy, planDetails });
    // æ³¨æ„ï¼šè¿™é‡Œä¸è¦æ¸…ç©º aiPlanï¼Œä»¥ä¿æŒé¡µé¢åˆ‡æ¢åçš„çŠ¶æ€
  };

  const generateAIPlan = async () => {
    if (!result) return;
    setIsGeneratingPlan(true);
    // ä¼˜åŒ– Promptï¼šæ˜ç¡®è¦æ±‚ä¸ä½¿ç”¨è¡¨æ ¼ï¼Œä½¿ç”¨æ¸…æ™°åˆ—è¡¨
    const prompt = `
      æˆ‘æ˜¯å¥èº«Appç”¨æˆ·ã€‚æ•°æ®: èº«é«˜${height}cm, ä½“é‡${weight}kg, BMI${result.bmi} (${result.type})ã€‚
      ç›®æ ‡: ${result.strategy}ã€‚
      
      è¯·ç”Ÿæˆä¸¤éƒ¨åˆ†å»ºè®®ï¼ˆä¸­æ–‡ï¼Œè¯­æ°”ä¸“ä¸šä¸”é¼“åŠ±ï¼‰ï¼š
      1. âœ¨ ä»Šæ—¥è®­ç»ƒç»†èŠ‚ï¼šåŸºäº"${result.strategy}"ï¼Œç»™å‡ºå…·ä½“çš„3-4ä¸ªåŠ¨ä½œã€ç»„æ•°å’Œæ¬¡æ•°ã€‚
      2. ğŸ¥— ä»Šæ—¥é¥®é£Ÿå»ºè®®ï¼šé’ˆå¯¹æ—©é¤ã€åˆé¤ã€æ™šé¤ç»™å‡ºå…·ä½“é£Ÿç‰©å»ºè®®ã€‚
      
      **æ ¼å¼è¦æ±‚**ï¼š
      - è¯·ä½¿ç”¨æ¸…æ™°çš„åˆ—è¡¨å’Œæ®µè½æ ¼å¼ã€‚
      - **ç»å¯¹ä¸è¦ä½¿ç”¨ Markdown è¡¨æ ¼**ï¼ˆä¸è¦ç”¨ |---| è¿™ç§æ ¼å¼ï¼‰ã€‚
      - å°æ ‡é¢˜ç”¨ "## " å¼€å¤´ã€‚
      - åˆ—è¡¨é¡¹ç”¨ "- " å¼€å¤´ã€‚
      - å…³é”®ä¿¡æ¯ç”¨ "**" åŒ…å›´ä»¥è¡¨ç¤ºåŠ ç²—ã€‚
    `;
    const text = await callGemini(prompt);
    setAiPlan(text);
    setIsGeneratingPlan(false);
    setTimeout(() => planRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
  };

  return (
    <div className="p-4 md:p-8 max-w-3xl mx-auto pb-24 overflow-y-auto scroll-smooth">
      <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-8 text-white shadow-xl mb-6 relative overflow-hidden">
        <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-blue-500 rounded-full opacity-20 blur-xl"></div>
        <h2 className="text-3xl font-bold mb-2 flex items-center relative z-10">
          <Calculator className="mr-3 w-8 h-8 text-blue-400" /> æ™ºèƒ½åˆ†æ
        </h2>
        <p className="opacity-80 relative z-10">åŸºäºèº«ä½“æ•°æ®ï¼Œå®šåˆ¶ç§‘å­¦çš„è®­ç»ƒä¸é¥®é£Ÿç­–ç•¥ã€‚</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-white/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-100">
          <label className="block text-xs font-bold text-slate-400 uppercase mb-1">èº«é«˜ (CM)</label>
          <input 
            type="number" value={height} onChange={(e) => setHeight(e.target.value)}
            className="w-full text-xl font-bold bg-transparent focus:outline-none text-slate-800 placeholder-slate-300"
            placeholder="175"
          />
        </div>
        <div className="bg-white/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-100">
          <label className="block text-xs font-bold text-slate-400 uppercase mb-1">ä½“é‡ (KG)</label>
          <input 
            type="number" value={weight} onChange={(e) => setWeight(e.target.value)}
            className="w-full text-xl font-bold bg-transparent focus:outline-none text-slate-800 placeholder-slate-300"
            placeholder="70"
          />
        </div>
        <button 
          onClick={calculate}
          className="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center justify-center py-4 md:py-0"
        >
          ç”ŸæˆæŠ¥å‘Š <ChevronRight className="ml-1 w-5 h-5" />
        </button>
      </div>

      {result && (
        <div className="animate-fade-in space-y-6">
          {/* Results Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
              <div className="text-xs text-slate-400 mb-1">BMI</div>
              <div className="text-2xl font-black text-slate-800">{result.bmi}</div>
            </div>
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center">
              <div className="text-xs text-slate-400 mb-1">ä½“å‹</div>
              <div className={`text-lg font-bold ${result.type === 'æ­£å¸¸èŒƒå›´' ? 'text-green-600' : 'text-orange-500'}`}>{result.type}</div>
            </div>
            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-center col-span-2 md:col-span-2 flex flex-col justify-center">
              <div className="text-xs text-slate-400 mb-1">å»ºè®®è›‹ç™½è´¨/å¤©</div>
              <div className="text-2xl font-black text-purple-600">{result.protein}</div>
            </div>
          </div>

          {/* Strategy Card */}
          <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
            <div className="bg-slate-50 p-4 border-b border-slate-100 flex items-center">
              <Activity className="w-5 h-5 text-blue-500 mr-2" />
              <span className="font-bold text-slate-700">å½“å‰ç­–ç•¥: {result.strategy}</span>
            </div>
            <div className="p-6">
              <p className="text-slate-600 leading-relaxed mb-4 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                {result.advice}
              </p>

              <div className="mb-6">
                <h4 className="font-bold text-slate-800 mb-3 text-sm">æ¨èå‘¨è®¡åˆ’ç¤ºä¾‹ï¼š</h4>
                <ul className="space-y-2">
                  {result.planDetails.map((detail, idx) => (
                    <li key={idx} className="text-sm text-slate-600 flex items-start">
                      <div className="w-1.5 h-1.5 rounded-full bg-blue-400 mt-1.5 mr-2 shrink-0"></div>
                      {detail}
                    </li>
                  ))}
                </ul>
              </div>
              
              {!aiPlan ? (
                <button 
                  onClick={generateAIPlan}
                  disabled={isGeneratingPlan}
                  className="w-full py-4 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white rounded-xl font-bold shadow-lg shadow-purple-200 hover:shadow-xl transition-all flex items-center justify-center group"
                >
                  {isGeneratingPlan ? <Loader2 className="animate-spin mr-2" /> : <Sparkles className="mr-2 group-hover:rotate-12 transition-transform" />}
                  {isGeneratingPlan ? 'AI æ­£åœ¨æ€è€ƒä¸­...' : 'ç”Ÿæˆä»Šæ—¥è¯¦ç»† AI è®¡åˆ’'}
                </button>
              ) : (
                <div ref={planRef} className="bg-white rounded-2xl p-6 border border-blue-100 shadow-lg animate-slide-up relative overflow-hidden">
                  <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-pink-500"></div>
                  <div className="flex justify-between items-center mb-6">
                    <h3 className="font-bold text-slate-800 flex items-center text-lg">
                      <div className="bg-purple-100 p-2 rounded-lg mr-3">
                        <Sparkles className="w-5 h-5 text-purple-600" />
                      </div>
                      AI å®šåˆ¶æ–¹æ¡ˆ
                    </h3>
                    <button onClick={generateAIPlan} className="text-xs text-slate-400 hover:text-blue-600 px-3 py-1 rounded-full border border-slate-200 hover:border-blue-200 transition-colors">
                      é‡æ–°ç”Ÿæˆ
                    </button>
                  </div>
                  
                  {/* å¢å¼ºçš„æ ¼å¼åŒ–æ¸²æŸ“å™¨ */}
                  <FormattedAIResponse text={aiPlan} />
                  
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 2.2 åŠ¨ä½œåº“ç»„ä»¶ (Modernized & Responsive)
const ExerciseLibrary = () => {
  const [selectedCategory, setSelectedCategory] = useState('å…¨éƒ¨');
  const [selectedEquipment, setSelectedEquipment] = useState('å…¨éƒ¨');
  const [selectedExercise, setSelectedExercise] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');

  // AI Chat State
  const [aiQuestion, setAiQuestion] = useState('');
  const [aiAnswer, setAiAnswer] = useState('');
  const [isAskingAi, setIsAskingAi] = useState(false);
  const chatEndRef = useRef(null);

  const filteredExercises = useMemo(() => {
    return EXERCISE_DATA.filter(ex => {
      const matchCat = selectedCategory === 'å…¨éƒ¨' || ex.category === selectedCategory;
      // å…¼å®¹æ–°çš„æ•°æ®ç±»å‹æ˜ å°„
      const matchEquip = selectedEquipment === 'å…¨éƒ¨' || 
                         (selectedEquipment === 'å£¶é“ƒ/è¯çƒ' && (ex.equipment === 'å£¶é“ƒ' || ex.equipment === 'è¯çƒ')) ||
                         (selectedEquipment === 'TRX/æˆ˜ç»³' && (ex.equipment === 'TRX' || ex.equipment === 'æˆ˜ç»³')) ||
                         ex.equipment.includes(selectedEquipment);
      const matchSearch = ex.name.toLowerCase().includes(searchQuery.toLowerCase());
      return matchCat && matchEquip && matchSearch;
    });
  }, [selectedCategory, selectedEquipment, searchQuery]);

  const handleAskAI = async () => {
    if (!aiQuestion.trim()) return;
    setIsAskingAi(true);
    setAiAnswer(''); 
    const prompt = `èƒŒæ™¯:ç”¨æˆ·æ­£åœ¨çœ‹åŠ¨ä½œâ€œ${selectedExercise.name}â€ã€‚æè¿°:${selectedExercise.description}ã€‚ç”¨æˆ·é—®:â€œ${aiQuestion}â€ã€‚è¯·åšä¸ºèµ„æ·±æ•™ç»ƒå›ç­”(ä¸­æ–‡,150å­—å†…,ä¸“ä¸šä¸”é¼“åŠ±)ã€‚`;
    const answer = await callGemini(prompt);
    setAiAnswer(answer);
    setIsAskingAi(false);
    setTimeout(() => chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
  };

  const closeExerciseModal = () => {
    setSelectedExercise(null);
    setAiQuestion('');
    setAiAnswer('');
    setIsAskingAi(false);
  };

  return (
    <div className="h-full flex flex-col bg-slate-50/50 relative">
      {/* Sticky Header with Glassmorphism */}
      <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 shadow-sm px-4 py-3">
        {/* Filters Row 1: Categories */}
        <div className="flex overflow-x-auto pb-2 mb-2 scrollbar-hide space-x-2 md:justify-center">
          {CATEGORIES.map(cat => (
            <button
              key={cat}
              onClick={() => setSelectedCategory(cat)}
              className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all active:scale-95 ${
                selectedCategory === cat 
                  ? 'bg-slate-800 text-white shadow-md shadow-slate-300' 
                  : 'bg-white text-slate-600 border border-slate-100 hover:bg-slate-50'
              }`}
            >
              {cat}
            </button>
          ))}
        </div>
        
        {/* Filters Row 2: Search & Equipment */}
        <div className="flex flex-col md:flex-row items-center gap-3 max-w-4xl mx-auto w-full">
           <div className="relative w-full md:w-48 shrink-0">
             <select 
              value={selectedEquipment}
              onChange={(e) => setSelectedEquipment(e.target.value)}
              className="w-full appearance-none bg-slate-100 border-0 text-slate-700 text-sm rounded-xl p-3 pr-8 focus:ring-2 focus:ring-blue-500 font-medium"
             >
               {EQUIPMENT_TYPES.map(eq => <option key={eq} value={eq}>{eq === 'å…¨éƒ¨' ? 'æ‰€æœ‰å™¨æ¢°' : eq}</option>)}
             </select>
             <ChevronDown className="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none" />
           </div>
           <div className="relative flex-1 w-full">
             <input 
              type="text" 
              placeholder="æœç´¢åŠ¨ä½œï¼Œä¾‹å¦‚ï¼šæ·±è¹²ã€æˆ˜ç»³..." 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full bg-slate-100 border-0 text-slate-700 text-sm rounded-xl p-3 pl-4 focus:ring-2 focus:ring-blue-500"
             />
           </div>
        </div>
      </div>

      {/* Responsive Grid for Exercises */}
      <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-24 touch-pan-y" style={{ WebkitOverflowScrolling: 'touch' }}>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-w-7xl mx-auto">
          {filteredExercises.length === 0 ? (
            <div className="col-span-full text-center py-20">
              <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Filter className="w-8 h-8 text-slate-300" />
              </div>
              <p className="text-slate-400">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åŠ¨ä½œ</p>
            </div>
          ) : (
            filteredExercises.map(exercise => (
              <div 
                key={exercise.id}
                onClick={() => setSelectedExercise(exercise)}
                className="group bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-100 hover:-translate-y-1 transition-all cursor-pointer flex flex-col justify-between h-full"
              >
                <div className="mb-4">
                  <div className="flex justify-between items-start mb-2">
                    <span className={`text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider ${
                      exercise.difficulty === 'ç®€å•' ? 'bg-green-50 text-green-600' : 
                      exercise.difficulty === 'ä¸­ç­‰' ? 'bg-yellow-50 text-yellow-600' : 
                      'bg-red-50 text-red-600'
                    }`}>
                      {exercise.difficulty}
                    </span>
                    <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                      <ChevronRight className="w-4 h-4 text-slate-400 group-hover:text-white" />
                    </div>
                  </div>
                  {/* Card Image Placeholder */}
                  <div className="w-full h-32 bg-slate-100 rounded-xl mb-3 overflow-hidden flex items-center justify-center relative">
                    {exercise.image ? (
                        <img src={exercise.image} alt={exercise.name} className="w-full h-full object-cover opacity-90 group-hover:scale-105 transition-transform duration-500" />
                    ) : (
                        <Dumbbell className="w-10 h-10 text-slate-300" />
                    )}
                  </div>
                  <h3 className="font-bold text-lg text-slate-800 mb-1 group-hover:text-blue-600 transition-colors">{exercise.name}</h3>
                  <p className="text-xs text-slate-500 line-clamp-2">{exercise.description}</p>
                </div>
                
                <div className="flex items-center gap-2 pt-4 border-t border-slate-50">
                  <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-50 text-xs font-medium text-slate-600">
                    <Dumbbell className="w-3 h-3 mr-1.5 text-slate-400" /> 
                    {exercise.equipment}
                  </span>
                  <span className="text-slate-300 text-xs">|</span>
                  <span className="text-xs font-medium text-blue-600">
                    {exercise.category}
                  </span>
                </div>
              </div>
            ))
          )}
        </div>
      </div>

      {/* Modern Fullscreen Modal for Details */}
      {selectedExercise && (
        <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-6 bg-slate-900/40 backdrop-blur-sm transition-all" onClick={closeExerciseModal}>
          <div 
            className="bg-white w-full max-h-[90vh] md:h-auto md:max-h-[85vh] md:max-w-2xl md:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col overflow-hidden animate-slide-up"
            onClick={e => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div className="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-6 md:p-8 relative shrink-0">
              <button onClick={closeExerciseModal} className="absolute right-6 top-6 p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors backdrop-blur-md">
                <X className="w-5 h-5" />
              </button>
              <h3 className="text-2xl md:text-3xl font-black mb-2 pr-8">{selectedExercise.name}</h3>
              <div className="flex flex-wrap gap-2 text-sm opacity-90">
                <span className="px-3 py-1 bg-white/10 rounded-lg backdrop-blur-md">{selectedExercise.equipment}</span>
                <span className="px-3 py-1 bg-white/10 rounded-lg backdrop-blur-md text-blue-200">{selectedExercise.muscles.join(' & ')}</span>
              </div>
            </div>

            {/* Modal Body */}
            <div 
              className="flex-1 overflow-y-auto p-6 md:p-8 space-y-8 bg-white touch-pan-y" 
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
              {/* Steps */}
              <div>
                <h4 className="font-bold text-slate-800 mb-4 flex items-center text-lg">
                  <CheckCircle className="w-5 h-5 mr-2 text-green-500" /> åŠ¨ä½œæ­¥éª¤
                </h4>
                <div className="space-y-4">
                  {selectedExercise.steps.map((step, idx) => (
                    <div key={idx} className="flex">
                      <div className="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-500 text-xs font-bold flex items-center justify-center mt-0.5 mr-3 border border-slate-200">
                        {idx + 1}
                      </div>
                      <p className="text-slate-600 leading-relaxed">{step}</p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Tips */}
              <div>
                <h4 className="font-bold text-slate-800 mb-4 flex items-center text-lg">
                  <AlertTriangle className="w-5 h-5 mr-2 text-amber-500" /> é¿å‘æŒ‡å—
                </h4>
                <div className="grid grid-cols-1 gap-3">
                  {selectedExercise.tips.map((tip, idx) => (
                    <div key={idx} className="bg-amber-50 p-4 rounded-xl border border-amber-100 flex items-start text-amber-800 text-sm leading-relaxed">
                      <Info className="w-4 h-4 mr-2 shrink-0 mt-0.5" />
                      {tip}
                    </div>
                  ))}
                </div>
              </div>

              {/* AI Coach */}
              <div className="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl p-5 md:p-6 border border-indigo-100 mb-safe-bottom">
                <h4 className="font-bold text-indigo-800 mb-2 flex items-center">
                  <Sparkles className="w-5 h-5 mr-2 text-indigo-600" /> AI éšèº«åŠ©æ•™
                </h4>
                <p className="text-sm text-indigo-600/80 mb-4">å¯¹åŠ¨ä½œæœ‰ç–‘é—®ï¼Ÿæ¯”å¦‚â€œè‚©è†€ç–¼â€ã€â€œæ²¡æœ‰å‘åŠ›æ„Ÿâ€ï¼Œéšæ—¶æé—®ã€‚</p>
                
                {aiAnswer && (
                  <div className="mb-4 bg-white p-4 rounded-xl text-slate-700 shadow-sm border border-indigo-50 animate-fade-in">
                    <div className="flex items-center mb-2 text-indigo-600 font-bold text-xs uppercase tracking-wider">
                      <MonitorSmartphone className="w-3 h-3 mr-1" /> IronPath AI
                    </div>
                    <div className="whitespace-pre-wrap leading-6">
                        {aiAnswer}
                    </div>
                  </div>
                )}

                <div className="flex gap-2">
                  <input 
                    type="text" 
                    value={aiQuestion}
                    onChange={(e) => setAiQuestion(e.target.value)}
                    placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                    className="flex-1 text-sm p-3 rounded-xl border border-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                    onKeyDown={(e) => e.key === 'Enter' && handleAskAI()}
                  />
                  <button 
                    onClick={handleAskAI}
                    disabled={isAskingAi || !aiQuestion.trim()}
                    className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 disabled:opacity-50 transition-all shadow-md shadow-indigo-200"
                  >
                    {isAskingAi ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// 2.3 æ¬¢è¿é¡µ (Welcome View)
const WelcomeView = ({ onStart }) => (
  <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-slate-900 text-white relative overflow-hidden">
    {/* Decorative Blobs */}
    <div className="absolute top-0 left-0 w-64 h-64 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-x-1/2 -translate-y-1/2 animate-blob"></div>
    <div className="absolute bottom-0 right-0 w-64 h-64 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-x-1/2 translate-y-1/2 animate-blob animation-delay-2000"></div>

    <div className="relative z-10 flex flex-col items-center">
      <div className="w-24 h-24 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-3xl flex items-center justify-center mb-8 shadow-2xl shadow-blue-900/50 transform rotate-3 hover:rotate-6 transition-transform duration-500">
        <Flame className="w-12 h-12 text-white" />
      </div>
      <h1 className="text-4xl md:text-5xl font-black mb-3 tracking-tight">IronPath</h1>
      <h2 className="text-lg md:text-xl font-medium text-slate-400 mb-10 tracking-wide">é’¢é“ä¹‹è·¯ Â· æ™ºèƒ½å¥èº«æŒ‡å—</h2>
      <div className="flex items-center gap-2 text-slate-400 text-sm mb-10 bg-slate-800/50 px-4 py-2 rounded-full backdrop-blur-sm border border-slate-700">
        <BookOpen className="w-4 h-4" />
        <span>å·²æ”¶å½• 40+ ä¸“ä¸šå™¨æ¢°ä¸åŠ¨ä½œæŒ‡å—</span>
      </div>
      
      <div className="space-y-4 w-full max-w-xs">
        <button 
          onClick={onStart}
          className="w-full bg-white text-slate-900 font-bold py-4 px-8 rounded-2xl shadow-xl hover:scale-105 hover:shadow-2xl transition-all flex items-center justify-center group"
        >
          å¼€å§‹å˜å¼º <ChevronRight className="ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" />
        </button>
        <p className="text-xs text-slate-500">v3.0 | å®˜æ–¹å™¨æ¢°åº“æ›´æ–°</p>
      </div>
    </div>
  </div>
);

// --- 3. ä¸»åº”ç”¨ç»„ä»¶ Main App ---

const App = () => {
  const [activeTab, setActiveTab] = useState('welcome'); 

  if (activeTab === 'welcome') return <WelcomeView onStart={() => setActiveTab('library')} />;

  return (
    <div className="h-screen w-full bg-slate-100 flex flex-col font-sans overflow-hidden">
      {/* Main Layout Container - Responsive */}
      <div className="flex-1 flex overflow-hidden w-full max-w-[1600px] mx-auto bg-white md:shadow-2xl md:my-4 md:rounded-[2rem] border-slate-200 relative">
        
        {/* Desktop Sidebar Navigation (Visible only on large screens) */}
        <div className="hidden md:flex flex-col w-24 lg:w-64 bg-slate-900 text-white pt-8 shrink-0 z-30">
          <div className="flex items-center justify-center lg:justify-start lg:px-8 mb-10">
            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg shadow-blue-900/50">
              <Flame className="w-6 h-6 text-white" />
            </div>
            <span className="hidden lg:block ml-3 font-bold text-xl tracking-tight">IronPath</span>
          </div>
          
          <div className="flex-1 space-y-2 px-4">
            <button 
              onClick={() => setActiveTab('library')}
              className={`w-full flex items-center p-3 rounded-xl transition-all ${activeTab === 'library' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
            >
              <Dumbbell className="w-6 h-6 lg:mr-3" />
              <span className="hidden lg:block font-medium">åŠ¨ä½œåº“</span>
            </button>
            <button 
              onClick={() => setActiveTab('analysis')}
              className={`w-full flex items-center p-3 rounded-xl transition-all ${activeTab === 'analysis' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
            >
              <Calculator className="w-6 h-6 lg:mr-3" />
              <span className="hidden lg:block font-medium">æ™ºèƒ½åˆ†æ</span>
            </button>
          </div>
          
          <div className="p-6 text-center lg:text-left text-xs text-slate-500">
            <span className="hidden lg:inline">Made for Gains ğŸ’ª</span>
          </div>
        </div>

        {/* Main Content Area - Using display:none for persistence instead of conditional rendering */}
        <main className="flex-1 overflow-hidden relative bg-slate-50/50 flex flex-col w-full">
          {/* Keep components mounted but hidden to preserve state */}
          <div className={`flex-1 flex flex-col h-full ${activeTab === 'library' ? 'flex' : 'hidden'}`}>
            <ExerciseLibrary />
          </div>
          <div className={`flex-1 flex flex-col h-full ${activeTab === 'analysis' ? 'flex' : 'hidden'}`}>
            <BodyAnalyzer />
          </div>
        </main>
      </div>

      {/* Mobile Bottom Navigation Bar (Hidden on desktop) */}
      <nav className="md:hidden bg-white/90 backdrop-blur-lg border-t border-slate-200 h-[calc(60px+env(safe-area-inset-bottom))] pb-[env(safe-area-inset-bottom)] flex items-center justify-around shrink-0 z-40 fixed bottom-0 w-full">
        <button 
          onClick={() => setActiveTab('library')}
          className={`flex flex-col items-center justify-center w-1/2 h-full transition-all ${activeTab === 'library' ? 'text-blue-600' : 'text-slate-400'}`}
        >
          <div className={`p-1.5 rounded-xl ${activeTab === 'library' ? 'bg-blue-50' : 'bg-transparent'}`}>
            <Dumbbell className={`w-6 h-6 ${activeTab === 'library' ? 'fill-current' : ''}`} />
          </div>
          <span className="text-[10px] font-medium mt-1">åŠ¨ä½œåº“</span>
        </button>
        
        <button 
          onClick={() => setActiveTab('analysis')}
          className={`flex flex-col items-center justify-center w-1/2 h-full transition-all ${activeTab === 'analysis' ? 'text-blue-600' : 'text-slate-400'}`}
        >
          <div className={`p-1.5 rounded-xl ${activeTab === 'analysis' ? 'bg-blue-50' : 'bg-transparent'}`}>
            <Activity className={`w-6 h-6 ${activeTab === 'analysis' ? 'fill-current' : ''}`} />
          </div>
          <span className="text-[10px] font-medium mt-1">æ™ºèƒ½åˆ†æ</span>
        </button>
      </nav>

      {/* Global Styles */}
      <style>{`
        @keyframes slide-up {
          from { transform: translateY(20px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .mb-safe-bottom { margin-bottom: env(safe-area-inset-bottom); }
      `}</style>
    </div>
  );
};

export default App;
